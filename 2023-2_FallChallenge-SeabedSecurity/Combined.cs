/**************************************************************
  This file was generated by FileConcatenator.
  It combined all classes in the project to work in Codingame.
***************************************************************/

using System.Drawing;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Collections;
using System.Runtime.CompilerServices;

internal class Creature
{
    internal int Id { get; private set; }
    internal int Color { get; private set; }
    internal int Type { get; private set; }

    internal bool IsVisible { get; set; }
    internal Point Position { get; set; }
    internal Point Velocity { get; set; }

    internal Creature(int id, int color, int type)
    {
        Id = id;
        Color = color;
        Type = type;
    }
}


internal enum CreatureDirection
{
    TL,
    TR,
    BL,
    BR
}

internal class DirectionCalculator
{
    private Game game;

    public DirectionCalculator(Game game)
    {
        this.game = game;
    }

    internal CreatureDirection GetBestDirectionFromRadarBlips(Drone drone)
    {
        // First pass
        // Just go in the direction with the most creatures
        Dictionary<CreatureDirection, int> directionCounts = new Dictionary<CreatureDirection, int>();

        foreach (var direction in drone.CreatureDirections)
        {
            var incrementAmount = 0;

            // If a creature has been scanned/stored by me don't count it
            if (game.MyScannedCreatureIds.Contains(direction.Key) || drone.ScannedCreaturesIds.Contains(direction.Key))
            {
                incrementAmount = 0;
            }
            // If it's been saved but not scanned/stored by me count it as one
            else if (game.EnemyScannedCreatureIds.Contains(direction.Key) && !game.MyScannedCreatureIds.Contains(direction.Key) && !drone.ScannedCreaturesIds.Contains(direction.Key))
            {
                incrementAmount = 1;
            }
            // If it's not been save by anyone and not stored by me count it as 3
            else if (!game.EnemyScannedCreatureIds.Contains(direction.Key) && !game.MyScannedCreatureIds.Contains(direction.Key) && !drone.ScannedCreaturesIds.Contains(direction.Key))
            {
                incrementAmount = 3;
            }

            if (directionCounts.ContainsKey(direction.Value))
            {
                directionCounts[direction.Value] += incrementAmount;
            }
            else
            {
                directionCounts[direction.Value] = incrementAmount;
            }
        }

        // return the key with the highest value
        return directionCounts.MaxBy(dc => dc.Value).Key;
         
    }
}

internal static class DistanceCalculator
{
    internal static int GetDistance(Point position1, Point position2)
    {
        var dx = position1.X - position2.X;
        var dy = position1.Y - position2.Y;
        return (int)Math.Sqrt(dx * dx + dy * dy);
    }
}

internal sealed class Drone
{
    internal int Id { get; private set; }

    internal Point Position { get; set; }
    internal int BatteryLevel { get; set; }

    internal HashSet<int> ScannedCreaturesIds { get; private set; } = new();

    internal Dictionary<int, CreatureDirection> CreatureDirections = new Dictionary<int, CreatureDirection>();

    internal Drone(int id, int xPos, int yPos, int batteryLevel)
    {
        Id = id;
        Position = new Point(xPos, yPos);
        BatteryLevel = batteryLevel;
    }

    internal void AddScannedCreatures(int id)
    {
        ScannedCreaturesIds.Add(id);
    }

    internal void AddCreatureDirection(int creatureId, CreatureDirection direction)
    {
        CreatureDirections[creatureId] = direction;
    }
}

internal class Game
{
    internal int MyScore { get; set; }
    internal int EnemyScore { get; set; }

    private List<Creature> creatures = [];
    private List<Drone> myDrones = [];
    private List<Drone> enemyDrones = [];

    internal HashSet<int> MyScannedCreatureIds { get; private set; } = new();
    internal HashSet<int> EnemyScannedCreatureIds { get; private set; } = new();

    private DirectionCalculator directionCalculator;

    internal int visibleCreatureCount;
    internal HashSet<int> VisibleMonsterIds { get; set; } = new();

    internal int round = 0;

    internal bool earlyGame = true;

    internal Dictionary<int, int> lastRoundTorchUsed = new();

    internal void InitialiseCreatures(List<Creature> allCreatures)
    {
        creatures = allCreatures;
        directionCalculator = new DirectionCalculator(this);
    }

    internal void AddScannedCreature(int creatureId, bool isMyDrone)
    {      
        if (isMyDrone)
        {
            MyScannedCreatureIds.Add(creatureId);
        }
        else
        {
            EnemyScannedCreatureIds.Add(creatureId);
        }
    }

    internal void SetMyDrones(List<Drone> drones)
    {
        myDrones = drones;
    }

    internal void SetEnemyDrones(List<Drone> drones)
    {
        enemyDrones = drones;
    }

    internal void UpdateCreaturePosition(int creatureId, int creatureX, int creatureY, int creatureVx, int creatureVy)
    {
        Creature creature = creatures.Find(c => c.Id == creatureId);
        if (creature != null)
        {
            creature.Position = new Point(creatureX, creatureY);
            creature.Velocity = new Point(creatureVx, creatureVy);
            creature.IsVisible = true;

            if (creature.Type != -1)
            {
                visibleCreatureCount++;
            }
            else
            {
                VisibleMonsterIds.Add(creatureId);
            }
        }
    }

    internal void SetAllCreaturesAsNotVisible()
    {
        visibleCreatureCount = 0;

        foreach (var creature in creatures)
        {
            creature.IsVisible = false;
        }
    }

    internal List<string> CalculateActions()
    {
        Console.Error.WriteLine($"Visible creatures this turn: {visibleCreatureCount}");

        round++;

        var actions = new List<string>();

        foreach (var drone in myDrones)
        {
            var action = string.Empty;

            var lightLevel = CalculateLightLevel(drone);

            Console.Error.WriteLine($"Drone {drone.Id}");

            // If the drone is within 2000 of a creature of type -1 set early game to false and evade the creature
            if (VisibleMonsterIds.Count > 0)
            {
                Console.Error.WriteLine($"Checking for monsters to evade...");
                foreach (var monsterId in VisibleMonsterIds)
                {
                    var monster = creatures.Find(c => c.Id == monsterId);
                    var distanceToMonster = DistanceCalculator.GetDistance(drone.Position, monster.Position);
                    Console.Error.WriteLine($"Distance to monster {monster.Id}: {distanceToMonster}");
                    if (distanceToMonster <= 2000)
                    {
                        Console.Error.WriteLine($"Evading monster {monster.Id}");
                        earlyGame = false;
                        // Move away from the monster
                        var directionX = drone.Position.X - monster.Position.X;
                        var directionY = drone.Position.Y - monster.Position.Y;

                        Console.Error.WriteLine($"Direction before normalization: ({directionX}, {directionY})");

                        //var length = (int)Math.Sqrt(directionX * directionX + directionY * directionY);
                        //directionX /= length;
                        //directionY /= length;

                        Console.Error.WriteLine($"Direction after normalization: ({directionX}, {directionY})");

                        var targetX = drone.Position.X + directionX;
                        var targetY = drone.Position.Y + directionY;
                        Console.Error.WriteLine($"Evade target position: ({targetX}, {targetY})");

                        action = $"MOVE {targetX} {targetY} {lightLevel}";
                        break;
                    }
                }
            }

            if (action != string.Empty)
            {
                actions.Add(action);
                continue;
            }

            if (earlyGame)
            {
                // Drop to 8,000+ then rise to the top
                if (drone.Position.Y >= 9000)
                {
                    earlyGame = false;

                }

                actions.Add($"MOVE {drone.Position.X} 9500 {lightLevel}");
            }
            else
            {
                // If stored scans >= 4 head to surface
                if (drone.ScannedCreaturesIds.Count >= 3 || MyScannedCreatureIds.Count + drone.ScannedCreaturesIds.Count >= 12)
                {
                    actions.Add($"MOVE {drone.Position.X} 500 {lightLevel}");
                }
                else
                {
                    // Move in the direction of the most unscanned fish
                    CreatureDirection direction = directionCalculator.GetBestDirectionFromRadarBlips(drone);

                    var targetPosition = new Point(0, 0);

                    switch (direction)
                    {
                        case CreatureDirection.TL:
                            targetPosition = new Point(drone.Position.X - 1000, drone.Position.Y - 1000);
                            break;
                        case CreatureDirection.TR:
                            targetPosition = new Point(drone.Position.X + 1000, drone.Position.Y - 1000);
                            break;
                        case CreatureDirection.BL:
                            targetPosition = new Point(drone.Position.X - 1000, drone.Position.Y + 1000);
                            break;
                        case CreatureDirection.BR:
                            targetPosition = new Point(drone.Position.X + 1000, drone.Position.Y + 1000);
                            break;
                    }

                    actions.Add($"MOVE {targetPosition.X} {targetPosition.Y} {lightLevel} {drone.BatteryLevel}");
                }
            }
        }

        return actions;
    }

    private int CalculateLightLevel(Drone drone)
    {
        var lightLevel = 0;

        if (lastRoundTorchUsed.ContainsKey(drone.Id))
        {
            var lastUsed = lastRoundTorchUsed[drone.Id];

            if (round - lastUsed >= 5)
            {
                lightLevel = 1;
                lastRoundTorchUsed[drone.Id] = round;
            }
        }
        else
        {
            lastRoundTorchUsed[drone.Id] = 0;
        }

        return lightLevel;
    }
}




internal static class Logger
{
    internal static void AllDrones(string? message, List<Drone> drones)
    {
        if (message != null)
        {
            Console.Error.WriteLine(message);
            Console.Error.WriteLine("==================================");
        }

        foreach (Drone drone in drones)
        {
            Drone(drone);
            Console.Error.WriteLine("------------------------");
        }
    }

    internal static void Drone(Drone drone)
    {
        Console.Error.WriteLine($"Drone {drone.Id}");
        Console.Error.WriteLine($"Position: {drone.Position.X},{drone.Position.Y}");
        Console.Error.WriteLine($"Battery:  {drone.BatteryLevel}");

        Console.Error.WriteLine($"Stored scans: {string.Join(" ", drone.ScannedCreaturesIds)}");

        Console.Error.WriteLine($"Creature directions: {string.Join(" ", drone.CreatureDirections.Select(kv => $"{kv.Key}:{kv.Value}"))}");
    }
}

class Player
{
    static void Main(string[] args)
    {
        var game = new Game();
        
        game.InitialiseCreatures(GetCreatures());

        // game loop
        while (true)
        {
            game.VisibleMonsterIds.Clear();

            int myScore = int.Parse(Console.ReadLine());
            game.MyScore = myScore;
            int foeScore = int.Parse(Console.ReadLine());
            game.EnemyScore = foeScore;

            AddSavedScans(game);

            List<Drone> myDrones = GetMyDrones();
            List<Drone> enemyDrones = GetEnemyDrones();

            AddStoredScans(myDrones, enemyDrones);

            UpdateCreatures(game);

            AddRadarBlips(game, myDrones, enemyDrones);

            game.SetMyDrones(myDrones);
            game.SetEnemyDrones(enemyDrones);

            List<string> actions = game.CalculateActions();

            foreach (string action in actions)
            {
                Console.WriteLine(action);
            }

            //Logger.AllDrones("My drones", myDrones);
            //Logger.AllDrones("Enemy drones", enemyDrones);
        }
    }    

    private static List<Creature> GetCreatures()
    {
        int creatureCount = int.Parse(Console.ReadLine());

        List<Creature> creatures = new List<Creature>();

        for (int i = 0; i < creatureCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int creatureId = int.Parse(inputs[0]);
            int color = int.Parse(inputs[1]);
            int type = int.Parse(inputs[2]);

            creatures.Add(new Creature(creatureId, color, type));
        }

        return creatures;
    }

    private static void AddSavedScans(Game game)
    {
        int myScanCount = int.Parse(Console.ReadLine());
        for (int i = 0; i < myScanCount; i++)
        {
            int creatureId = int.Parse(Console.ReadLine());
            game.AddScannedCreature(creatureId, true);
        }
        int foeScanCount = int.Parse(Console.ReadLine());
        for (int i = 0; i < foeScanCount; i++)
        {
            int creatureId = int.Parse(Console.ReadLine());
            game.AddScannedCreature(creatureId, false);
        }
    }

    private static List<Drone> GetMyDrones()
    {
        int myDroneCount = int.Parse(Console.ReadLine());
        var myDrones = new List<Drone>();

        for (int i = 0; i < myDroneCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int droneId = int.Parse(inputs[0]);
            int droneX = int.Parse(inputs[1]);
            int droneY = int.Parse(inputs[2]);
            int emergency = int.Parse(inputs[3]);
            int battery = int.Parse(inputs[4]);

            myDrones.Add(new Drone(droneId, droneX, droneY, battery));
        }

        return myDrones;
    }

    private static List<Drone> GetEnemyDrones()
    {
        int foeDroneCount = int.Parse(Console.ReadLine());
        var enemyDrones = new List<Drone>();

        for (int i = 0; i < foeDroneCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int droneId = int.Parse(inputs[0]);
            int droneX = int.Parse(inputs[1]);
            int droneY = int.Parse(inputs[2]);
            int emergency = int.Parse(inputs[3]);
            int battery = int.Parse(inputs[4]);

            enemyDrones.Add(new Drone(droneId, droneX, droneY, battery));
        }

        return enemyDrones;
    }

    private static void UpdateCreatures(Game game)
    {
        game.SetAllCreaturesAsNotVisible();

        int visibleCreatureCount = int.Parse(Console.ReadLine());

        Console.Error.WriteLine($"Visible creature count: {visibleCreatureCount}");
        for (int i = 0; i < visibleCreatureCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int creatureId = int.Parse(inputs[0]);
            int creatureX = int.Parse(inputs[1]);
            int creatureY = int.Parse(inputs[2]);
            int creatureVx = int.Parse(inputs[3]);
            int creatureVy = int.Parse(inputs[4]);

            game.UpdateCreaturePosition(creatureId, creatureX, creatureY, creatureVx, creatureVy);
        }
    }

    private static void AddStoredScans(List<Drone> myDrones, List<Drone> enemyDrones)
    {
        int droneScanCount = int.Parse(Console.ReadLine());
        for (int i = 0; i < droneScanCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int droneId = int.Parse(inputs[0]);
            int creatureId = int.Parse(inputs[1]);

            Drone drone = myDrones.FirstOrDefault(d => d.Id == droneId);
            if (drone == null)
            {
                drone = enemyDrones.FirstOrDefault(d => d.Id == droneId);
            }

            if (drone != null)
            {
                drone.ScannedCreaturesIds.Add(creatureId);
            }
        }
    }
    
    private static void AddRadarBlips(Game game, List<Drone> myDrones, List<Drone> enemyDrones)
    {
        int radarBlipCount = int.Parse(Console.ReadLine());
        for (int i = 0; i < radarBlipCount; i++)
        {
            string[] inputs = Console.ReadLine().Split(' ');
            int droneId = int.Parse(inputs[0]);
            int creatureId = int.Parse(inputs[1]);
            string radar = inputs[2];

            Drone drone = myDrones.FirstOrDefault(d => d.Id == droneId);
            if (drone == null)
            {
                drone = enemyDrones.FirstOrDefault(d => d.Id == droneId);
            }

            if (drone != null)
            {
                drone.AddCreatureDirection(creatureId, (CreatureDirection)Enum.Parse(typeof(CreatureDirection), radar));
            }
        }
    }
}


